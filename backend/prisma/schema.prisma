// Prisma Schema for PickleHub

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String        @id @default(uuid())
  email         String        @unique
  name          String
  googleId      String?       @unique
  appleId       String?       @unique
  profileImage  String?

  // Profile fields
  nickname              String?
  bio                   String?   // 自己紹介文
  region                String?
  pickleballExperience  String?   // e.g., "6ヶ月", "1年", "3年以上"
  gender                String?   // "male", "female", "other", "prefer_not_to_say"
  skillLevel            String?   // "beginner", "intermediate", "advanced"
  duprDoubles           Float?    // DUPR rating for doubles (up to 3 decimal places)
  duprSingles           Float?    // DUPR rating for singles (up to 3 decimal places)
  myPaddle              String?   // ユーザーの使用パドル
  isProfileComplete     Boolean   @default(false)

  // SNS Links
  instagramUrl          String?
  twitterUrl            String?
  tiktokUrl             String?
  lineUrl               String?

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  eventsCreated       Event[]             @relation("EventCreator")
  reservations        Reservation[]
  messages            Message[]
  teamsOwned          Team[]              @relation("TeamOwner")
  teamMemberships     TeamMember[]
  teamJoinRequests    TeamJoinRequest[]
  teamInvitesCreated  TeamInviteUrl[]     @relation("InviteCreator")
  teamInvitesUsed     TeamInviteUrl[]     @relation("InviteUser")
  teamEventsCreated   TeamEvent[]         @relation("TeamEventCreator")
  teamEventParticipations TeamEventParticipant[]
  teamMessages        TeamMessage[]
  notifications       Notification[]

  @@index([googleId])
  @@index([appleId])
  @@index([email])
}

model Event {
  id              String        @id @default(uuid())
  title           String
  description     String
  location        String
  region          String?
  startTime       DateTime
  endTime         DateTime
  maxParticipants Int
  skillLevel      String        // "beginner", "intermediate", "advanced", "all"
  price           Int?          // 料金 (円単位、null = 無料)
  status          String        @default("active") // "active", "cancelled", "completed"
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  creatorId       String
  creator         User          @relation("EventCreator", fields: [creatorId], references: [id], onDelete: Cascade)
  reservations    Reservation[]
  chatRoom        ChatRoom?

  @@index([creatorId])
  @@index([startTime])
  @@index([status])
  @@index([region])
}

model Reservation {
  id          String   @id @default(uuid())
  status      String   @default("confirmed") // "confirmed", "cancelled"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  eventId     String
  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([userId, eventId])
  @@index([userId])
  @@index([eventId])
  @@index([status])
}

model ChatRoom {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  eventId   String    @unique
  event     Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  messages  Message[]
}

model Message {
  id         String   @id @default(uuid())
  content    String
  createdAt  DateTime @default(now())

  // Relations
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  chatRoomId String
  chatRoom   ChatRoom @relation(fields: [chatRoomId], references: [id], onDelete: Cascade)

  @@index([chatRoomId, createdAt])
  @@index([userId])
}

// ============= TEAM MODELS =============

model Team {
  id          String   @id @default(uuid())
  name        String
  description String
  iconImage   String?
  headerImage String?  // ヘッダー画像
  region      String?
  visibility  String   @default("public") // "public", "private"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // SNS Links
  instagramUrl String?
  twitterUrl   String?
  tiktokUrl    String?
  lineUrl      String?

  // Relations
  ownerId         String
  owner           User                @relation("TeamOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members         TeamMember[]
  joinRequests    TeamJoinRequest[]
  inviteUrls      TeamInviteUrl[]
  events          TeamEvent[]
  chatRoom        TeamChatRoom?

  @@index([ownerId])
  @@index([visibility])
  @@index([name])
  @@index([region])
}

model TeamMember {
  id        String   @id @default(uuid())
  role      String   // "owner", "admin", "member"
  joinedAt  DateTime @default(now())

  // Relations
  teamId    String
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
  @@index([role])
}

model TeamJoinRequest {
  id        String   @id @default(uuid())
  status    String   @default("pending") // "pending", "approved", "rejected"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  teamId    String
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
  @@index([status])
}

model TeamInviteUrl {
  id        String    @id @default(uuid())
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  // Relations
  teamId      String
  team        Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  createdBy   String
  creator     User      @relation("InviteCreator", fields: [createdBy], references: [id], onDelete: Cascade)
  usedBy      String?
  usedByUser  User?     @relation("InviteUser", fields: [usedBy], references: [id], onDelete: SetNull)

  @@index([token])
  @@index([teamId])
  @@index([expiresAt])
}

model TeamEvent {
  id              String   @id @default(uuid())
  title           String
  description     String
  location        String
  region          String?
  startTime       DateTime
  endTime         DateTime
  maxParticipants Int?     // null = unlimited
  price           Int?     // 料金 (円単位、null = 無料)
  skillLevel      String?  @default("all") // "beginner", "intermediate", "advanced", "all"
  status          String   @default("active") // "active", "completed", "cancelled"
  visibility      String   @default("private") // "public" (通常イベントとしても公開), "private" (チームメンバーのみ)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  teamId      String
  team        Team                    @relation(fields: [teamId], references: [id], onDelete: Cascade)
  createdBy   String
  creator     User                    @relation("TeamEventCreator", fields: [createdBy], references: [id], onDelete: Cascade)
  participants TeamEventParticipant[]

  @@index([teamId])
  @@index([createdBy])
  @@index([startTime])
  @@index([visibility])
}

model TeamEventParticipant {
  id        String   @id @default(uuid())
  status    String   @default("confirmed") // "confirmed", "cancelled"
  joinedAt  DateTime @default(now())

  // Relations
  eventId   String
  event     TeamEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
  @@index([status])
}

model TeamChatRoom {
  id        String        @id @default(uuid())
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  // Relations
  teamId    String        @unique
  team      Team          @relation(fields: [teamId], references: [id], onDelete: Cascade)
  messages  TeamMessage[]
}

model TeamMessage {
  id         String       @id @default(uuid())
  content    String
  createdAt  DateTime     @default(now())

  // Relations
  userId       String
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  chatRoomId   String
  chatRoom     TeamChatRoom @relation(fields: [chatRoomId], references: [id], onDelete: Cascade)

  @@index([chatRoomId, createdAt])
  @@index([userId])
}

// ============= NOTIFICATION MODEL =============

model Notification {
  id         String   @id @default(uuid())
  type       String   // notification type enum
  title      String
  message    String
  relatedId  String?  // eventId, teamId, etc.
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())

  // Relations
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@index([userId, isRead])
}
